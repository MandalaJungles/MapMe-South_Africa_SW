<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>MapMe — Cape Town (iPad Touch‑Optimized)</title>

<link rel="preconnect" href="https://unpkg.com">
<link rel="dns-prefetch" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">

<style>
  html, body { height:100%; margin:0; }
  #app { display:flex; height:100%; width:100%; overflow:hidden; }
  #sidebar{
    width: 330px; min-width: 290px; max-width: 420px;
    padding:14px; box-sizing:border-box; background:#fafafa; border-right:1px solid #ddd;
    overflow-y:auto; -webkit-overflow-scrolling:touch;
  }
  #map{ flex:1; min-height:300px; height:100%; }
  h1{ font-size:18px; margin:0 0 10px; }
  .group{ margin-bottom:14px; }
  label{ display:block; margin:8px 0; font-size:16px; }
  input[type="text"]{
    width:100%; font-size:16px; padding:10px; border:1px solid #ccc; border-radius:8px;
  }
  button{
    font-size:16px; padding:10px 14px; border:1px solid #333; background:#fff; border-radius:10px;
    touch-action:manipulation; -webkit-tap-highlight-color: transparent;
  }
  .pill{ display:inline-block; padding:6px 10px; border:1px solid #999; border-radius:999px; margin:4px 6px 0 0; }
  .hint{ font-size:13px; color:#666; }
  .note{ font-size:13px; background:#fffbe6; border:1px solid #f0e6a0; padding:8px; border-radius:8px; }
  .warn{ font-size:13px; background:#ffecec; border:1px solid #f5b5b5; padding:8px; border-radius:8px; }

  @media (max-width: 900px){ #sidebar{ width:45%; } }
  @media (max-width: 700px){
    #sidebar{ width:100%; position:absolute; z-index:1000; height:42%; bottom:0; top:auto; border-right:none; border-top:1px solid #ddd; background:#fff; }
    #map{ flex:1; }
  }
</style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <h1>MapMe — Cape Town</h1>

    <div class="group">
      <div class="pill">Touch‑friendly</div>
      <div class="pill">Add a Place</div>
      <div class="pill">MyCiTi 104 Highlight</div>
      <div class="hint">Tiles & live data require internet.</div>
    </div>

    <div class="group">
      <strong>Base Layers</strong>
      <label><input type="radio" name="basemap" value="osm" checked> OpenStreetMap</label>
      <label><input type="radio" name="basemap" value="sat"> Satellite</label>
    </div>

    <div class="group">
      <strong>MyCiTi Routes</strong>
      <label><input type="checkbox" id="toggleRoutes" checked> Show All Routes (thin)</label>
      <label><input type="checkbox" id="toggle104" checked> Highlight 104 (pale yellow)</label>
      <div id="routeStatus" class="hint">Loading routes…</div>
    </div>

    <div class="group">
      <strong>Quick Zooms</strong><br/>
      <button id="zoomVA">V&A Waterfront</button>
      <button id="zoomCBD">CBD / Adderley</button>
      <button id="zoomSeaPoint">Sea Point</button>
    </div>

    <div class="group">
      <strong>Add a Place</strong>
      <div class="hint">Enter an address or <code>lat,lon</code>. Tap “Add”. Long‑press map to drop a pin.</div>
      <input id="placeInput" type="text" inputmode="text" placeholder="e.g., 39 Beach Road, Cape Town  or  -33.909, 18.400">
      <div style="margin-top:8px; display:flex; gap:8px;">
        <button id="addBtn">Add</button>
        <button id="clearUser">Clear Added</button>
      </div>
      <div id="addStatus" class="hint" aria-live="polite"></div>
    </div>

    <div class="group">
      <strong>Preloaded POIs</strong>
      <label><input type="checkbox" id="poiFood" checked> Restaurants & Cafés</label>
      <label><input type="checkbox" id="poiSights" checked> Sights & Museums</label>
      <div class="hint">OSM POIs around the V&amp;A Waterfront.</div>
      <div id="poiStatus" class="hint"></div>
    </div>

    <div class="group">
      <details>
        <summary><strong>Notes & Sources</strong></summary>
        <div class="hint">
          Map © OpenStreetMap contributors; tiles © OSM / Esri. POIs via Overpass API (OSM). MyCiTi routes via City of Cape Town ArcGIS services.
        </div>
      </details>
    </div>
  </div>

  <div id="map" role="region" aria-label="Interactive Cape Town map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<script>
(function(){
  // iPad zoom “snap-back” fix: when Safari UI changes height, reflow tiles instead of jumping zoom
  function refresh(){ map.invalidateSize({animate:false}); }
  window.addEventListener('resize', refresh, {passive:true});
  window.addEventListener('orientationchange', refresh, {passive:true});

  // --- Map setup ---
  const map = L.map('map', { zoomControl:true, tap:true, preferCanvas:true })
               .setView([-33.9075, 18.4207], 13);

  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    { maxZoom:19, detectRetina:true, attribution:'&copy; OpenStreetMap' }).addTo(map);

  const esriSat = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { maxZoom:19, attribution:'Imagery &copy; Esri' }
  );

  document.querySelectorAll('input[name="basemap"]').forEach(r=>{
    r.addEventListener('change', ()=>{
      if (r.value === 'osm'){ if(!map.hasLayer(osm)) map.addLayer(osm); map.removeLayer(esriSat); }
      else { if(!map.hasLayer(esriSat)) map.addLayer(esriSat); map.removeLayer(osm); }
    });
  });

  // --- Quick zooms ---
  document.getElementById('zoomVA').onclick  = ()=> map.setView([-33.9066, 18.4203], 15);
  document.getElementById('zoomCBD').onclick = ()=> map.setView([-33.9249, 18.4241], 15);
  document.getElementById('zoomSeaPoint').onclick = ()=> map.setView([-33.9159, 18.3873], 14);

  // --- User pins layer & helpers ---
  const userLayer = L.featureGroup().addTo(map);
  function addDraggableMarker(lat, lon, label){
    const m = L.marker([lat, lon], { draggable:true }).addTo(userLayer);
    m.bindPopup(label || (lat.toFixed(5)+', '+lon.toFixed(5))).openPopup();
    return m;
  }

  // Pre-pin apartment (corrected for 39 Beach Road, Sea Point)
  addDraggableMarker(-33.90905, 18.39962, 'Your Apartment — 39 Beach Road');

  // Long‑press to drop a pin
  let pressTimer, pressStart=null;
  map.on('touchstart', (e)=>{ pressStart = e.latlng; pressTimer = setTimeout(()=> {
    if (pressStart) addDraggableMarker(pressStart.lat, pressStart.lng, 'Dropped pin');
  }, 550); });
  map.on('touchend', ()=>{ clearTimeout(pressTimer); pressStart=null; });

  // --- Add-a-Place (with small UX status) ---
  const addStatus = document.getElementById('addStatus');
  function setAddStatus(msg){ addStatus.textContent = msg || ''; }
  function parseLatLon(txt){
    const m = txt.match(/^\s*(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)\s*$/);
    return m ? {lat: parseFloat(m[1]), lon: parseFloat(m[2])} : null;
  }
  async function geocode(query){
    const url = 'https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&addressdetails=0&namedetails=0&accept-language=en&q=' + encodeURIComponent(query);
    const res = await fetch(url, { headers:{'Accept-Language':'en'} });
    if(!res.ok) throw new Error('Geocoder HTTP '+res.status);
    const js = await res.json();
    if (Array.isArray(js) && js[0]) return { lat: parseFloat(js[0].lat), lon: parseFloat(js[0].lon) };
    return null;
  }
  document.getElementById('addBtn').onclick = async ()=>{
    const v = document.getElementById('placeInput').value.trim();
    if(!v){ setAddStatus('Enter an address or lat,lon'); return; }
    setAddStatus('Finding place…');
    const coords = parseLatLon(v);
    try{
      const latlon = coords || await geocode(v);
      if (!latlon){ setAddStatus('No result. Try -33.909, 18.400'); return; }
      addDraggableMarker(latlon.lat, latlon.lon, v);
      map.setView([latlon.lat, latlon.lon], 16);
      setAddStatus('Added ✓'); setTimeout(()=>setAddStatus(''),1200);
    }catch(e){ setAddStatus('Geocoding blocked/offline. Try lat,lon.'); }
  };
  document.getElementById('clearUser').onclick = ()=> { userLayer.clearLayers(); setAddStatus('Cleared added pins.'); setTimeout(()=>setAddStatus(''),1000); };

  // --- POIs around V&A Waterfront via Overpass ---
  const poiFood = L.layerGroup().addTo(map);
  const poiSights = L.layerGroup().addTo(map);
  const poiStatus = document.getElementById('poiStatus');

  async function loadPOIs(){
    const bbox = [18.406, -33.914, 18.428, -33.899]; // minlon,minlat,maxlon,maxlat
    const overpass = 'https://overpass-api.de/api/interpreter';
    const query = `
      [out:json][timeout:25];
      (
        node["amenity"~"restaurant|cafe|fast_food"](bbox);
        node["tourism"~"museum|attraction|gallery"](bbox);
      );
      out center;`.replace(/bbox/g, bbox.join(','));
    try{
      const r = await fetch(overpass, { method:'POST', body:query, headers:{'Content-Type':'text/plain'} });
      if(!r.ok) throw new Error('Overpass HTTP '+r.status);
      const j = await r.json();
      (j.elements||[]).forEach(el=>{
        const lat = el.lat || (el.center && el.center.lat);
        const lon = el.lon || (el.center && el.center.lon);
        if (lat==null || lon==null) return;
        const name = (el.tags && el.tags.name) ? el.tags.name : 'Unnamed';
        const isFood  = !!(el.tags && el.tags.amenity);
        const marker = L.circleMarker([lat,lon], { radius:6, weight:1, color: isFood ? '#c66' : '#336', fillOpacity:0.25 });
        marker.bindPopup(`<strong>${name}</strong><br>${isFood?'Restaurant/Café':'Sight/Attraction'}`);
        (isFood ? poiFood : poiSights).addLayer(marker);
      });
      poiStatus.textContent = '';
    }catch(e){
      poiStatus.textContent = 'POIs unavailable right now (Overpass throttled).';
    }
  }
  loadPOIs();

  document.getElementById('poiFood').onchange = (e)=> e.target.checked ? map.addLayer(poiFood) : map.removeLayer(poiFood);
  document.getElementById('poiSights').onchange = (e)=> e.target.checked ? map.addLayer(poiSights) : map.removeLayer(poiSights);

  // --- MyCiTi routes (highlight 104) via ArcGIS FeatureServer ---
  const ROUTE_SERVICES = [
    'https://citymaps.capetown.gov.za/agsext/rest/services/Theme_Based/Open_Data_Service/FeatureServer/95',
    'https://citymaps.capetown.gov.za/agsext/rest/services/Theme_Based/ODP_SPLIT_6/FeatureServer/9',
    'https://gis.westerncape.gov.za/server2/rest/services/SpatialDataWarehouse/Transportation/MapServer/9'
  ];
  const allRoutes = L.layerGroup().addTo(map);
  const route104  = L.layerGroup().addTo(map);

  // explicit styles so there’s no fallback to Leaflet’s default blue
  const styleAll  = { color:'#8a8a8a', weight:2, opacity:0.7, lineCap:'round', lineJoin:'round' };
  const style104  = { color:'#fff6a6', weight:6, opacity:0.95, lineCap:'round', lineJoin:'round' }; // pale yellow

  const routeStatus = document.getElementById('routeStatus');

  function looksLike104(props){
    const keys = Object.keys(props||{});
    const fields = ['ROUTE_NO','ROUTENUMBER','ROUTE','ROUTENAME','NAME','LINENAME','LINE_NAME','LINEID','SHORT_NAME','LONG_NAME','DESC'];
    let text = '';
    for (let i=0;i<fields.length;i++){ const k = fields[i]; if (keys.includes(k) && props[k]!=null){ text += ' ' + String(props[k]); } }
    return /\b104\b/.test(text);
  }

  async function fetchGeoJSON(service){
    const url = service + '/query?where=1%3D1&outFields=*&f=geojson&outSR=4326';
    const res = await fetch(url, { cache:'no-store' });
    if (!res.ok) throw new Error('ArcGIS fetch failed: '+res.status);
    return res.json();
  }

  function addRoutes(geojson){
    let count104 = 0;
    L.geoJSON(geojson, {
      style: ()=> styleAll,
      onEachFeature: (f, layer)=> allRoutes.addLayer(layer)
    });
    L.geoJSON(geojson, {
      filter: (f)=> { const hit = looksLike104(f && f.properties ? f.properties : {}); if (hit) count104++; return hit; },
      style: ()=> style104,
      onEachFeature: (f, layer)=> route104.addLayer(layer)
    });
    if (count104>0){ routeStatus.textContent = 'Route 104 highlighted.'; }
    else { routeStatus.innerHTML = '<span class="warn">Could not find route 104 in this dataset.</span>'; }
  }

  (async function loadRoutes(){
    for (let i=0;i<ROUTE_SERVICES.length;i++){
      try{
        const gj = await fetchGeoJSON(ROUTE_SERVICES[i]);
        addRoutes(gj);
        if(!routeStatus.textContent) routeStatus.textContent = 'Routes loaded.';
        syncRouteToggles(); // ensure checkbox state applies after load
        break;
      }catch(e){
        if (i === ROUTE_SERVICES.length-1){
          routeStatus.innerHTML = '<span class="warn">Routes unavailable (service blocked or offline).</span>';
        }
      }
    }
  })();

  // robust checkbox handlers
  const chkAll  = document.getElementById('toggleRoutes');
  const chk104  = document.getElementById('toggle104');
  function syncRouteToggles(){
    if (chkAll.checked)  { if(!map.hasLayer(allRoutes)) map.addLayer(allRoutes); }
    else                 { if(map.hasLayer(allRoutes))  map.removeLayer(allRoutes); }

    if (chk104.checked)  { if(!map.hasLayer(route104))  map.addLayer(route104); }
    else                 { if(map.hasLayer(route104))   map.removeLayer(route104); }
  }
  chkAll.addEventListener('change', syncRouteToggles);
  chk104.addEventListener('change', syncRouteToggles);
})();
</script>
</body>
</html>
