<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>MapMe — Cape Town (iPad Touch‑Optimized)</title>

<!-- Auto cache‑bust the whole page once per load -->
<script>
  (function () {
    try {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
      }
      if (!location.search.includes('v=')) {
        var ver = Date.now();
        location.replace(location.pathname + '?v=' + ver + location.hash);
      }
    } catch(e) {}
  })();
</script>

<link rel="preconnect" href="https://unpkg.com">
<link rel="dns-prefetch" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css?v=1" crossorigin="anonymous">
<style>
  html, body { height:100svh; height:100%; margin:0; }
  #app { display:flex; height:100%; width:100%; overflow:hidden; }
  #sidebar{
    width: 330px; min-width: 290px; max-width: 420px;
    padding:14px; box-sizing:border-box; background:#fafafa; border-right:1px solid #ddd;
    overflow-y:auto; -webkit-overflow-scrolling:touch;
  }
  #map{ flex:1; touch-action: pan-x pan-y; }
  h1{ font-size:18px; margin:0 0 10px; }
  .group{ margin-bottom:14px; }
  label{ display:block; margin:8px 0; font-size:16px; }
  input[type="text"]{ width:100%; font-size:16px; padding:10px; border:1px solid #ccc; border-radius:8px; }
  button{
    font-size:16px; padding:10px 14px; border:1px solid #333; background:#fff; border-radius:10px;
    touch-action:manipulation; -webkit-tap-highlight-color: transparent;
  }
  .hint{ font-size:13px; color:#666; }
  .warn{ font-size:13px; background:#ffecec; border:1px solid #f5b5b5; padding:8px; border-radius:8px; }
  @media (max-width: 900px){ #sidebar{ width:45%; } }
  @media (max-width: 700px){
    #sidebar{ width:100%; position:absolute; z-index:1000; height:42%; bottom:0; top:auto; border-right:none; border-top:1px solid #ddd; background:#fff; }
    #map{ flex:1; }
  }
</style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <h1>MapMe — Cape Town</h1>

    <div class="group">
      <strong>Base Layers</strong>
      <label><input type="radio" name="basemap" value="osm" checked> OpenStreetMap</label>
      <label><input type="radio" name="basemap" value="sat"> Satellite</label>
      <div class="hint">Tiles & live data require internet.</div>
    </div>

    <div class="group">
      <strong>MyCiTi Routes</strong>
      <label><input type="checkbox" id="toggleRoutes" checked> Show All Routes (thin)</label>
      <label><input type="checkbox" id="toggle104" checked> Highlight 104 (pale yellow)</label>
      <div id="routeStatus" class="hint">Loading routes…</div>
    </div>

    <div class="group">
      <strong>Quick Zooms</strong><br/>
      <button id="zoomVA">V&A Waterfront</button>
      <button id="zoomCBD">CBD / Adderley</button>
      <button id="zoomSeaPoint">Sea Point</button>
    </div>

    <div class="group">
      <strong>Add a Place</strong>
      <div class="hint">Enter an address or <code>lat,lon</code>. Tap “Add”. Long‑press map to drop a pin.</div>
      <input id="placeInput" type="text" placeholder="e.g., 39 Beach Road, Cape Town  or  -33.907, 18.409">
      <div style="margin-top:8px; display:flex; gap:8px;">
        <button id="addBtn">Add</button>
        <button id="clearUser">Clear Added</button>
      </div>
    </div>

    <div class="group">
      <strong>Preloaded POIs</strong>
      <label><input type="checkbox" id="poiFood" checked> Restaurants & Cafés</label>
      <label><input type="checkbox" id="poiSights" checked> Sights & Museums</label>
      <div id="poiStatus" class="hint"></div>
    </div>

    <div class="group">
      <details>
        <summary><strong>Notes & Sources</strong></summary>
        <div class="hint">
          Map © OpenStreetMap contributors; tiles © OSM / Esri. POIs via Overpass API (OSM). MyCiTi routes via City of Cape Town ArcGIS services.
        </div>
      </details>
    </div>
  </div>

  <div id="map" role="region" aria-label="Interactive Cape Town map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js?v=1" crossorigin="anonymous"></script>
<script>
(function(){
  // ===== Map setup with deeper zoom & smoother touch =====
  const map = L.map('map', {
      zoomControl: true,
      tap: true,
      preferCanvas: true,
      zoomSnap: 0.25,
      zoomDelta: 0.5,
      wheelDebounceTime: 25,
      touchZoom: 'center',
      maxZoom: 23
  }).setView([-33.9075, 18.4207], 14);

  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 23, maxNativeZoom: 19, detectRetina: true, attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const esriSat = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { maxZoom: 23, maxNativeZoom: 19, attribution:'Imagery &copy; Esri' }
  );

  window.addEventListener('orientationchange', ()=> setTimeout(()=> map.invalidateSize(), 250));
  window.addEventListener('resize', ()=> setTimeout(()=> map.invalidateSize(), 250));
  document.querySelectorAll('input[name="basemap"]').forEach(r=>{
    r.addEventListener('change', ()=>{
      if (r.value === 'osm'){ map.addLayer(osm); map.removeLayer(esriSat); }
      else { map.addLayer(esriSat); map.removeLayer(osm); }
    });
  });

  // ===== Quick zooms =====
  document.getElementById('zoomVA').onclick  = ()=> map.setView([-33.9066, 18.4203], 16);
  document.getElementById('zoomCBD').onclick = ()=> map.setView([-33.9249, 18.4241], 16);
  document.getElementById('zoomSeaPoint').onclick = ()=> map.setView([-33.9159, 18.3873], 15);

  // ===== User pins =====
  const userLayer = L.featureGroup().addTo(map);
  function addDraggableMarker(lat, lon, label){
    const m = L.marker([lat, lon], { draggable:true }).addTo(userLayer);
    m.bindPopup(label || (lat.toFixed(5)+', '+lon.toFixed(5)));
    return m;
  }

  // Long‑press to drop a pin; cancel while moving/zooming
  let pressTimer, pressStart=null, moved=false;
  function clearPress(){ clearTimeout(pressTimer); pressTimer=null; pressStart=null; moved=false; }
  map.on('movestart zoomstart dragstart', clearPress);
  map.on('touchstart', (e)=>{
    moved=false; pressStart = e.latlng;
    pressTimer = setTimeout(()=> { if (pressStart && !moved) addDraggableMarker(pressStart.lat, pressStart.lng, 'Dropped pin').openPopup(); }, 650);
  });
  map.on('touchmove', ()=>{ moved=true; });
  map.on('touchend', clearPress);

  // ===== Add‑a‑place =====
  document.getElementById('addBtn').onclick = async ()=>{
    const v = document.getElementById('placeInput').value.trim();
    if(!v) return;
    const m = v.match(/^\s*(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)\s*$/);
    if (m){
      const lat = parseFloat(m[1]), lon = parseFloat(m[2]);
      addDraggableMarker(lat, lon, v).openPopup(); map.setView([lat,lon], 17); return;
    }
    try{
      const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(v);
      const res = await fetch(url, { headers:{'Accept-Language':'en'} });
      const js  = await res.json();
      if (js && js[0]){
        const lat = parseFloat(js[0].lat), lon = parseFloat(js[0].lon);
        addDraggableMarker(lat, lon, v).openPopup(); map.setView([lat,lon], 17);
      } else { alert('No result found. Try coordinates lat,lon.'); }
    }catch(e){ alert('Geocoding error. Try coordinates lat,lon.'); }
  };
  document.getElementById('clearUser').onclick = ()=> userLayer.clearLayers();

  // ===== On‑load geocode for your apartment (no guessing) =====
  (async function locateApartment(){
    const address = '39 Beach Road, Sea Point, Cape Town';
    try{
      const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(address);
      const res = await fetch(url, { headers:{'Accept-Language':'en'} });
      const js  = await res.json();
      if (js && js[0]){
        const lat = parseFloat(js[0].lat), lon = parseFloat(js[0].lon);
        addDraggableMarker(lat, lon, 'Your Apartment — 39 Beach Road').openPopup();
        map.setView([lat,lon], 17);
      } else {
        // fallback: don’t place anything if we can’t verify
      }
    }catch(e){}
  })();

  // ===== POIs via Overpass =====
  const poiFood = L.layerGroup().addTo(map);
  const poiSights = L.layerGroup().addTo(map);
  const poiStatus = document.getElementById('poiStatus');
  async function loadPOIs(){
    const bbox = [18.406, -33.914, 18.428, -33.899];
    const overpass = 'https://overpass-api.de/api/interpreter';
    const query = `
      [out:json][timeout:25];
      (
        node["amenity"~"restaurant|cafe|fast_food"](bbox);
        node["tourism"~"museum|attraction|gallery"](bbox);
      );
      out center;`.replace(/bbox/g, bbox.join(','));
    try{
      const r = await fetch(overpass, { method:'POST', body:query, headers:{'Content-Type':'text/plain'} });
      const j = await r.json();
      (j.elements||[]).forEach(el=>{
        const lat = el.lat || (el.center && el.center.lat);
        const lon = el.lon || (el.center && el.center.lon);
        if (lat==null || lon==null) return;
        const name = (el.tags && el.tags.name) ? el.tags.name : 'Unnamed';
        const cat  = (el.tags && el.tags.amenity) ? 'food' : 'sight';
        const marker = L.circleMarker([lat,lon], { radius:6, weight:1 });
        marker.bindPopup(`<strong>${name}</strong><br>${cat==='food'?'Restaurant/Café':'Sight/Attraction'}`);
        (cat==='food' ? poiFood : poiSights).addLayer(marker);
      });
      poiStatus.textContent = '';
    }catch(e){
      poiStatus.textContent = 'POIs unavailable right now (Overpass throttled).';
    }
  }
  loadPOIs();
  document.getElementById('poiFood').onchange = (e)=> e.target.checked ? map.addLayer(poiFood) : map.removeLayer(poiFood);
  document.getElementById('poiSights').onchange = (e)=> e.target.checked ? map.addLayer(poiSights) : map.removeLayer(poiSights);

  // ===== MyCiTi routes (highlight 104) =====
  const allRoutes = L.layerGroup().addTo(map);
  const route104  = L.layerGroup().addTo(map);
  const styleAll  = { color:'#8a8a8a', weight:2, opacity:0.7 };
  const style104  = { color:'#fff6a6', weight:6, opacity:0.95 }; // pale yellow
  const routeStatus = document.getElementById('routeStatus');

  // Candidate FeatureServer layers we can query
  const ROUTE_SERVICES = [
    'https://citymaps.capetown.gov.za/agsext/rest/services/Theme_Based/Open_Data_Service/FeatureServer/95',
    'https://citymaps.capetown.gov.za/agsext/rest/services/Theme_Based/ODP_SPLIT_6/FeatureServer/9',
    'https://gis.westerncape.gov.za/server2/rest/services/SpatialDataWarehouse/Transportation/MapServer/9'
  ];
  // “All routes” is drawn via a simple 1=1 query:
  async function fetchAllRoutes(service){
    const url = service + '/query?where=1%3D1&outFields=*&f=geojson&outSR=4326';
    const r = await fetch(url, { cache:'no-store' });
    if (!r.ok) throw new Error('ArcGIS fetch failed');
    return r.json();
  }
  function drawAll(gj){ L.geoJSON(gj, { style:()=>styleAll, onEachFeature:(f,layer)=> allRoutes.addLayer(layer) }); }

  // Try multiple field names/where clauses to find “104”
  const WHERE_104 = [
    "ROUTE_NO=104",
    "ROUTENUMBER=104",
    "SHORT_NAME='104'",
    "LONG_NAME LIKE '%104%'",
    "ROUTE LIKE '%104%'",
    "ROUTENAME LIKE '%104%'",
    "NAME LIKE '%104%'",
    "LINE_NAME LIKE '%104%'",
    "LINENAME LIKE '%104%'"
  ];
  async function tryFind104(service){
    // First, draw all routes so you at least see the network
    try{
      const all = await fetchAllRoutes(service);
      drawAll(all);
    }catch(_){}
    for (let w of WHERE_104){
      const url = service + '/query?where=' + encodeURIComponent(w) + '&outFields=*&f=geojson&outSR=4326';
      try{
        const r = await fetch(url, { cache:'no-store' });
        if (!r.ok) continue;
        const gj = await r.json();
        let has = false;
        L.geoJSON(gj, {
          style: ()=> style104,
          onEachFeature: (f, layer)=>{ has=true; route104.addLayer(layer); }
        });
        if (has) return true;
      }catch(_){}
    }
    return false;
  }
  (async function loadRoutes(){
    for (let i=0;i<ROUTE_SERVICES.length;i++){
      const ok = await tryFind104(ROUTE_SERVICES[i]);
      if (ok){ routeStatus.textContent = 'Route 104 highlighted.'; break; }
      if (i===ROUTE_SERVICES.length-1){
        routeStatus.innerHTML = '<span class="warn">Could not find route 104 in the available datasets.</span>';
      }
    }
  })();

  document.getElementById('toggleRoutes').onchange = (e)=> e.target.checked ? map.addLayer(allRoutes) : map.removeLayer(allRoutes);
  document.getElementById('toggle104').onchange   = (e)=> e.target.checked ? map.addLayer(route104)  : map.removeLayer(route104);
})();
</script>
</body>
</html>
