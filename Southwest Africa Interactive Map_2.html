<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Cape Town Interactive Map — iPad Touch-Optimized</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="dns-prefetch" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha512-sA+e2M8b9vOqk2zR5z0d9lUoZ9M2Q8rQmFJHc0C8m1n0o7cQ5l7V3q9uS0L2q5qz6wqzG1wB9z0l8iKk5xX0xw==" crossorigin="anonymous">
<style>
  html, body { height:100%; margin:0; }
  #app { display:flex; height:100%; width:100%; overflow:hidden; }
  #sidebar {
    width: 330px; min-width: 290px; max-width: 420px;
    padding: 14px; box-sizing: border-box; background:#fafafa; border-right:1px solid #ddd;
    overflow-y:auto; -webkit-overflow-scrolling:touch;
  }
  #map { flex:1; }
  h1 { font-size:18px; margin:0 0 10px; }
  .group { margin-bottom:14px; }
  label { display:block; margin:8px 0; font-size:16px; }
  input[type="text"] {
    width:100%; font-size:16px; padding:10px; border:1px solid #ccc; border-radius:8px;
  }
  button {
    font-size:16px; padding:10px 14px; border:1px solid #333; background:#fff; border-radius:10px;
    touch-action:manipulation; -webkit-tap-highlight-color: transparent;
  }
  .pill { display:inline-block; padding:6px 10px; border:1px solid #999; border-radius:999px; margin:4px 6px 0 0; }
  .hint { font-size:13px; color:#666; }
  .note { font-size:13px; background:#fffbe6; border:1px solid #f0e6a0; padding:8px; border-radius:8px; }
  @media (max-width: 900px) {
    #sidebar { width: 45%; }
  }
  @media (max-width: 700px) {
    #sidebar { width: 100%; position:absolute; z-index:1000; height:40%; bottom:0; top:auto; border-right:none; border-top:1px solid #ddd; background:#fff; }
    #map { flex:1; }
  }
</style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <h1>Cape Town Map</h1>

    <div class="group">
      <div class="pill">Touch‑friendly</div>
      <div class="pill">Offline‑ready UI*</div>
      <div class="pill">MyCiTi 104 highlighted</div>
      <div class="hint">*Tiles & live data need internet; the interface works offline.</div>
    </div>

    <div class="group">
      <strong>Base Layers</strong>
      <label><input type="radio" name="basemap" value="osm" checked> OpenStreetMap</label>
      <label><input type="radio" name="basemap" value="sat"> Satellite</label>
    </div>

    <div class="group">
      <strong>MyCiTi Routes</strong>
      <label><input type="checkbox" id="toggleRoutes" checked> Show All Routes (thin)</label>
      <label><input type="checkbox" id="toggle104" checked> Highlight 104 (pale yellow)</label>
      <div class="hint">If routes disappear, give it a few seconds—ArcGIS may rate‑limit briefly.</div>
    </div>

    <div class="group">
      <strong>Quick Zooms</strong><br/>
      <button id="zoomVA">V&A Waterfront</button>
      <button id="zoomCBD">CBD / Adderley</button>
      <button id="zoomSeaPoint">Sea Point</button>
    </div>

    <div class="group">
      <strong>Add a Place</strong>
      <div class="hint">Enter an address, landmark, or coordinates (lat,lon). Tap “Add”.</div>
      <input id="placeInput" type="text" placeholder="e.g., 39 Beach Road, Cape Town or -33.907, 18.409">
      <div style="margin-top:8px; display:flex; gap:8px;">
        <button id="addBtn">Add</button>
        <button id="clearUser">Clear Added</button>
      </div>
      <div class="note" style="margin-top:8px;">
        Tip: Long‑press on the map to drop a pin. Drag to reposition.
      </div>
    </div>

    <div class="group">
      <strong>Preloaded POIs (toggle)</strong>
      <label><input type="checkbox" id="poiFood" checked> Restaurants</label>
      <label><input type="checkbox" id="poiSights" checked> Sights</label>
      <div class="hint">POIs load from OpenStreetMap around the V&amp;A Waterfront.</div>
    </div>

    <div class="group">
      <details>
        <summary><strong>Attribution & Sources</strong></summary>
        <div class="hint">
          Map © OpenStreetMap contributors; tiles © OSM & ESRI. MyCiTi routes from City of Cape Town Open Data (ArcGIS FeatureServer). Geocoding via Nominatim.
        </div>
      </details>
    </div>
  </div>
  <div id="map" role="region" aria-label="Interactive Cape Town map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha512-vhYQJg1u3j7h+3QyLz6w5lD9kJw9Z3RrJrH8z6kG6s6nX1m0Lkz3s8s6u4o6c8v2wQf2FQqv3FvR9kPMoQH0xw=="
  crossorigin="anonymous"></script>

<script>
(function(){
  // --- Base map (safe defaults for iPad) ---
  const map = L.map('map', { zoomControl: true, tap: true, preferCanvas: true }).setView([-33.9075, 18.4207], 13);

  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, detectRetina: true, attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const esriSat = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { maxZoom: 19, attribution: 'Imagery © Esri' }
  );

  document.querySelectorAll('input[name="basemap"]').forEach(r=>{
    r.addEventListener('change', ()=>{
      if (r.value === 'osm'){ map.addLayer(osm); map.removeLayer(esriSat); }
      else { map.addLayer(esriSat); map.removeLayer(osm); }
    });
  });

  // --- Touch helpers ---
  map.on('click', ()=>{}); // ensure first tap focuses map on iPad
  map.gestureHandling = true;

  // --- Quick zooms ---
  document.getElementById('zoomVA').onclick = ()=> map.setView([-33.9066, 18.4203], 15);
  document.getElementById('zoomCBD').onclick = ()=> map.setView([-33.9249, 18.4241], 15);
  document.getElementById('zoomSeaPoint').onclick = ()=> map.setView([-33.9159, 18.3873], 14);

  // --- User pins (add via text or long-press) ---
  const userLayer = L.featureGroup().addTo(map);
  function addDraggableMarker(lat, lon, label){
    const m = L.marker([lat, lon], { draggable: true }).addTo(userLayer);
    m.bindPopup(label || `${lat.toFixed(5)}, ${lon.toFixed(5)}`).openPopup();
    return m;
  }

  // Long-press to drop pin (approx)
  let pressTimer, pressStartLatLng=null;
  map.on('touchstart', (e)=>{ pressStartLatLng = e.latlng; pressTimer = setTimeout(()=> {
    if (pressStartLatLng) addDraggableMarker(pressStartLatLng.lat, pressStartLatLng.lng, 'Dropped pin');
  }, 550); });
  map.on('touchend', ()=>{ clearTimeout(pressTimer); pressStartLatLng = null; });

  document.getElementById('addBtn').onclick = async ()=>{
    const v = document.getElementById('placeInput').value.trim();
    if(!v) return;
    // If lat,lon
    const coordMatch = v.match(/^\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*$/);
    if (coordMatch){
      const lat = parseFloat(coordMatch[1]), lon = parseFloat(coordMatch[3]);
      addDraggableMarker(lat, lon, v); map.setView([lat,lon], 16); return;
    }
    // Geocode with Nominatim
    try{
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(v)}&limit=1&addressdetails=0`;
      const res = await fetch(url, { headers: { 'Accept-Language': 'en' }});
      const js = await res.json();
      if (js && js[0]){
        const lat = parseFloat(js[0].lat), lon = parseFloat(js[0].lon);
        addDraggableMarker(lat, lon, v); map.setView([lat,lon], 16);
      } else {
        alert('No result found.');
      }
    }catch(e){ alert('Geocoding error. Try coordinates.'); }
  };
  document.getElementById('clearUser').onclick = ()=> userLayer.clearLayers();

  // --- POIs from OSM (Around V&A Waterfront bbox) ---
  const poiFood = L.layerGroup().addTo(map);
  const poiSights = L.layerGroup().addTo(map);

  async function loadPOIs(){
    const bbox = [18.406, -33.914, 18.428, -33.899]; // (minlon,minlat,maxlon,maxlat) around V&A
    const overpass = 'https://overpass-api.de/api/interpreter';
    const query = `
      [out:json][timeout:25];
      (
        node["amenity"~"restaurant|cafe|fast_food"](bbox);
        node["tourism"~"museum|attraction|gallery"](bbox);
      );
      out center;`;
    const q = query.replace(/bbox/g, bbox.join(','));
    try{
      const r = await fetch(overpass, { method:'POST', body: q, headers: {'Content-Type':'text/plain'} });
      const j = await r.json();
      (j.elements||[]).forEach(el=>{
        const lat=el.lat||el.center?.lat, lon=el.lon||el.center?.lon; if(!lat||!lon) return;
        const name = el.tags?.name || 'Unnamed';
        const cat = el.tags?.amenity ? 'food' : 'sight';
        const marker = L.circleMarker([lat,lon], { radius: 6, weight: 1 });
        marker.bindPopup(`<strong>${name}</strong><br>${cat==='food'?'Restaurant/Cafe':'Sight/Attraction'}`);
        if (cat==='food') marker.addTo(poiFood); else marker.addTo(poiSights);
      });
    }catch(e){ /* silent if API throttles */ }
  }
  loadPOIs();

  document.getElementById('poiFood').onchange = (e)=> e.target.checked ? map.addLayer(poiFood) : map.removeLayer(poiFood);
  document.getElementById('poiSights').onchange = (e)=> e.target.checked ? map.addLayer(poiSights) : map.removeLayer(poiSights);

  // --- MyCiTi Routes from City of Cape Town Open Data (ArcGIS FeatureServer) ---
  // Public layers (polyline): multiple mirrors; try primary then secondary.
  const ROUTE_SERVICES = [
    // FeatureServer (recommended for GeoJSON)
    'https://citymaps.capetown.gov.za/agsext/rest/services/Theme_Based/Open_Data_Service/FeatureServer/95',
    'https://citymaps.capetown.gov.za/agsext/rest/services/Theme_Based/ODP_SPLIT_6/FeatureServer/9',
    'https://gis.westerncape.gov.za/server2/rest/services/SpatialDataWarehouse/Transportation/MapServer/9'
  ];

  const allRoutes = L.layerGroup().addTo(map);
  const route104 = L.layerGroup().addTo(map);

  // Thin gray for all, pale yellow wide for 104
  const styleAll = { color:'#8a8a8a', weight:2, opacity:0.7 };
  const style104 = { color:'#fff6a6', weight:6, opacity:0.95 }; // pale yellow

  async function fetchGeoJSON(serviceUrl){
    const url = `${serviceUrl}/query?where=1%3D1&outFields=*&f=geojson&outSR=4326`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('ArcGIS fetch failed');
    return await res.json();
  }

  function looksLike104(props){
    const keys = Object.keys(props||{});
    // Try common field names observed in CoCT data
    const candidates = ['ROUTE_NO','ROUTENUMBER','ROUTE','ROUTENAME','NAME','LINENAME','LINE_NAME','LINEID','SHORT_NAME','LONG_NAME'];
    let text = '';
    candidates.forEach(k=>{ if(keys.includes(k)) text += ' ' + (props[k]??''); });
    text += ' ' + (props?.toString?.() || '');
    return /\b104\b/.test(String(text));
  }

  function addRoutes(geojson){
    L.geoJSON(geojson, {
      style: feature => styleAll,
      onEachFeature: (feat, layer) => { allRoutes.addLayer(layer); }
    });
    L.geoJSON(geojson, {
      filter: feat => looksLike104(feat.properties||{}),
      style: feature => style104,
      onEachFeature: (feat, layer) => { route104.addLayer(layer); }
    });
  }

  (async ()=>{
    for (const s of ROUTE_SERVICES){
      try { const gj = await fetchGeoJSON(s); addRoutes(gj); break; }
      catch(e){ /* try next */ }
    }
  })();

  document.getElementById('toggleRoutes').onchange = (e)=> e.target.checked ? map.addLayer(allRoutes) : map.removeLayer(allRoutes);
  document.getElementById('toggle104').onchange = (e)=> e.target.checked ? map.addLayer(route104) : map.removeLayer(route104);

})();
</script>
</body>
</html>